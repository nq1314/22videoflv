<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>学堂课程录制</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<meta name="screen-orientation" content="portrait">
		<meta name="x5-orientation" content="portrait">
		
		<meta name="apple-touch-fullscreen" content="YES" />
		<meta name="format-detection" content="telephone=no" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta http-equiv="Expires" content="-1" />
		<meta http-equiv="pragram" content="no-cache" />
		
		<script>!function(e){function t(a){if(i[a])return i[a].exports;var n=i[a]={exports:{},id:a,loaded:!1};return e[a].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=window;t["default"]=i.flex=function(normal,e,t){var a=e||100,n=t||1,r=i.document,o=navigator.userAgent,d=o.match(/Android[\S\s]+AppleWebkit\/(\d{3})/i),l=o.match(/U3\/((\d+|\.){5,})/i),c=l&&parseInt(l[1].split(".").join(""),10)>=80,p=navigator.appVersion.match(/(iphone|ipad|ipod)/gi),s=i.devicePixelRatio||1;p||d&&d[1]>534||c||(s=1);var u=normal?1:1/s,m=r.querySelector('meta[name="viewport"]');m||(m=r.createElement("meta"),m.setAttribute("name","viewport"),r.head.appendChild(m)),m.setAttribute("content","width=device-width,user-scalable=no,initial-scale="+u+",maximum-scale="+u+",minimum-scale="+u),r.documentElement.style.fontSize=normal?"50px": a/2*s*n+"px"},e.exports=t["default"]}]);  flex(false,100, 1);
				document.documentElement.style.fontSize = document.documentElement.clientWidth / 640*100 + 'px';
		</script>
		<link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.3.0/video-js.min.css" rel="stylesheet">
		<!--移动端版本兼容 -->
		<script type="text/javascript">
		    var phoneWidth =  parseInt(window.screen.width);
		    var phoneScale = phoneWidth/640;
		    var ua = navigator.userAgent;
		    if (/Android (\d+\.\d+)/.test(ua)){
		        var version = parseFloat(RegExp.$1);
		        // andriod 2.3
		        if(version>2.3){
		            document.write('<meta name="viewport" content="width=640, minimum-scale = '+phoneScale+', maximum-scale = '+phoneScale+', target-densitydpi=device-dpi">');
		        // andriod 2.3以上
		        }else{
		            document.write('<meta name="viewport" content="width=640, target-densitydpi=device-dpi">');
		        }
		        // 其他系统
		    } else {
		        document.write('<meta name="viewport" content="width=640, user-scalable=no, target-densitydpi=device-dpi">');
		    }
		    //微信去掉下方刷新栏
		    if(RegExp("MicroMessenger").test(navigator.userAgent)){
		        document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
		            WeixinJSBridge.call('hideToolbar');
		        });
		    }
		</script>
		<link type="text/css" rel="stylesheet" href="style.css">
	</head>
<body>
            <div id="videos-container">
            </div>

            <button id="openCamera">打开摄像头</button>
            <button id="start-recording" disabled>开始录制</button>
            <button id="save-recording" disabled>保存</button>
            <a href="javascript:void(0)" οnclick="send()">发送</a>
            <!-- 遮罩样式 -->
            <div class="v-shadow">
                 <!-- 直播样式 -->
                <div class="ving">
                    <div class="v-teacher">
                        <img src="" alt=""> <span>张老师</span>
                    </div>
                    <p class="v-title">直播的标题呀呀</p>
                    <div class="v-visiters">
                        <img src="" alt=""><img src="" alt=""><img src="" alt="">
                        <img src="" alt=""><img src="" alt=""><img src="" alt="">
                        <span>300人</span>
                    </div>
                    <div class="v-gift"> 
                        <svg t="1563270890637" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32754" width="50" height="50">
                            <path d="M994.27287 378.641513c-11.799972-11.799972-24.599942-22.539947-38.199911-32.179925l0.579999-0.839998c28.199934-16.93996 46.659891-82.779806 46.65989-82.779806s-22.359948-49.879883-54.719871-77.939817l2.619994-0.02c41.179903-48.219887 23.819944-136.59968 23.819944-136.59968s-89.999789-17.679959-137.919677 24.979941C808.833304 41.702302 760.473418 20.002353 760.473418 20.002353s-65.679846 18.419957-82.719806 46.559891c-8.53998-11.459973-17.859958-22.299948-27.979935-32.419924-15.619963-15.619963-38.41991-13.079969-50.919881 5.659987s-9.959977 46.599891 5.659987 62.219854l-101.819761 152.739642c-39.939906 59.91986-35.999916 146.439657 6.639984 202.659525 4.019991 5.339987 52.699876 54.419872 55.979869 57.159866 55.919869 46.81989 146.359657 52.459877 208.339512 11.139974l152.739642-101.819762c15.619963 15.619963 43.479898 18.159957 62.219854 5.659987 18.739956-12.499971 21.27995-35.299917 5.659987-50.91988z" fill="#FD6D9A" p-id="32755"></path>
                            <path d="M217.374691 865.420372c109.339744-109.339744 286.619328-109.339744 395.979071 0l56.559868 56.559867c-109.339744 109.359744-286.639328 109.359744-395.979072 0l-56.559867-56.559867z" fill="#3BCD92" p-id="32756"></path><path d="M565.313875 514.581194L88.794992 992.280074c-15.619963 15.619963-40.939904 15.619963-56.559868 0s-15.619963-40.939904 0-56.559867l477.098882-478.298879c4.019991 5.339987 52.699876 54.419872 55.979869 57.159866z" fill="#BF6015" p-id="32757"></path><path d="M217.374691 745.720652l-56.579868-56.559867c-109.339744-109.339744-109.339744-286.639328 0-395.979072l56.579868 56.559867c109.339744 109.359744 109.339744 286.639328 0 395.979072z" fill="#3BCD92" p-id="32758"></path><path d="M202.734725 505.301216c7.799982-7.799982 7.799982-20.459952 0-28.279934-7.819982-7.799982-20.479952-7.799982-28.299934 0-7.799982 7.819982-7.799982 20.479952 0 28.279934a19.999953 19.999953 0 0 0 28.299934 0z" fill="" p-id="32759"></path><path d="M986.102889 344.693592c21.13395-26.621938 33.275922-66.845843 35.969916-76.451821a19.999953 19.999953 0 0 0-1.007998-13.581968c-0.841998-1.881996-18.205957-40.177906-45.263894-70.375835 34.34192-55.61587 19.081955-136.175681 18.357957-139.857672a20.001953 20.001953 0 0 0-15.769963-15.769963c-3.715991-0.727998-84.221803-15.961963-139.845672 18.377957-30.197929-27.063937-68.527839-44.447896-70.379835-45.279894a20.015953 20.015953 0 0 0-13.587969-1.009998c-9.539978 2.675994-49.351884 14.689966-75.975821 35.591917A309.269275 309.269275 0 0 0 663.417645 20.002353c-24.521943-24.525943-62.211854-20.513952-81.701808 8.70198-14.573966 21.847949-14.807965 51.569879-2.125995 73.901827l-94.03778 141.063669c-40.731905 61.111857-41.387903 147.679654-2.519994 211.299505l-176.177587 176.621586c29.419931-101.683762 4.14999-215.987494-75.839822-295.993307l-56.581868-56.559867c-7.807982-7.807982-20.471952-7.805982-28.281934 0.002-116.969726 116.969726-116.969726 307.29328 0.002 424.267006l44.645896 44.631895-173.203594 173.639593c-23.449945 23.445945-23.455945 61.391856-0.002 84.841801 23.141946 23.145946 61.109857 23.735944 84.861801-0.016l113.419734-113.699733 43.417898 43.415898C315.950459 992.790073 391.288283 1024 471.424095 1024s155.473636-31.207927 212.131503-87.877794c7.809982-7.809982 7.807982-20.471952 0-28.283934l-56.561868-56.559867c-79.331814-79.315814-192.387549-104.823754-293.423312-76.561821l233.177454-233.753452c63.461851 42.5979 153.68564 43.941897 217.49949 1.399997l141.061669-94.03578c22.331948 12.67997 52.055878 12.445971 73.899827-2.125995 29.195932-19.473954 33.247922-57.159866 8.70598-81.699808a311.743269 311.743269 0 0 0-21.811949-19.807954z m-32.341924-23.503945c-33.99792-21.687949-72.843829-37.835911-114.103733-47.429889 1.439997-4.19999 2.883993-8.38798 4.31399-12.51797 8.267981-23.891944 16.733961-48.465886 22.951946-73.565828a568.554667 568.554667 0 0 1 39.327908-1.391997c8.56198 0 18.229957 4.619989 28.735933 13.729968 22.085948 19.151955 39.557907 50.927881 46.423891 64.521849-6.077986 18.875956-16.817961 43.559898-27.649935 56.653867z m3.049992-255.189402c2.209995 21.063951 3.737991 61.781855-11.937972 91.839785-12.76397-7.671982-25.69394-11.559973-38.619909-11.559973-10.475975 0-21.061951 0.313999-31.655926 0.869998 1.279997-10.485975 1.933995-20.627952 1.933996-30.587928 0-12.93997-3.885991-25.873939-11.561973-38.62991 30.05793-15.679963 70.797834-14.139967 91.841784-11.931972z m-198.517534-24.601942c13.319969 6.713984 44.057897 23.595945 63.433851 45.217894 9.823977 10.953974 14.805965 21.027951 14.805965 29.94593 0 14.853965-1.697996 30.335929-5.197987 47.365889-5.709987 28.023934-15.599963 56.597867-25.163941 84.229802a3295.832275 3295.832275 0 0 0-6.347986 18.471957 399.881063 399.881063 0 0 0-35.657916-2.873993c-2.511994-71.495832-23.921944-139.801672-61.381856-195.685542 13.283969-10.507975 36.865914-20.683952 55.50987-26.671937z m-239.459439 224.457474l101.819761-152.739642a19.999953 19.999953 0 0 0-2.497994-25.235941c-8.893979-8.891979-10.373976-26.171939-3.163992-36.977913 5.329988-7.993981 13.249969-9.505978 20.139952-2.615994 54.697872 54.699872 90.641788 139.077674 89.263791 234.949449v0.004c-0.735998 51.967878-12.82197 102.43376-34.951918 145.937658-29.71793 58.437863-89.229791 75.753822-137.523678 42.455901-0.14-0.102-0.285999-0.19-0.427999-0.288a114.959731 114.959731 0 0 1-15.355964-12.923969c-48.111887-48.091887-55.62587-135.069683-17.301959-192.565549zM160.834823 322.001645l41.895902 41.879902c91.099786 91.115786 100.309765 233.565453 27.661935 335.069215l-18.679956-130.719694c-1.561996-10.933974-11.699973-18.529957-22.627947-16.96796-10.933974 1.561996-18.531957 11.693973-16.96796 22.627947l16.471961 115.27373-14.151967-14.147967C77.819018 578.403044 73.289028 424.037406 160.834823 322.001645zM74.151026 978.138107a19.983953 19.983953 0 0 1-28.275934-0.002 19.975953 19.975953 0 0 1 0.02-28.291933L507.86001 486.713259a155.815635 155.815635 0 0 0 17.979958 15.407964 153.871639 153.871639 0 0 0 10.425975 12.75197L74.151026 978.138107z m524.560771-98.575768l41.887902 41.885901C593.515809 961.924145 534.163948 984.000094 471.424095 984.000094c-69.451837 0-134.741684-27.045937-183.847569-76.161822l-14.129967-14.129967 115.25773 16.471962c0.959998 0.136 1.913996 0.204 2.855993 0.203999 9.791977 0 18.347957-7.197983 19.773954-17.171959 1.561996-10.935974-6.035986-21.065951-16.96796-22.627947l-130.719694-18.681957c101.499762-72.65183 243.951428-63.439851 335.065215 27.659936z m378.303113-466.638907c-10.803975 7.209983-28.083934 5.729987-36.977913-3.163992a19.999953 19.999953 0 0 0-25.235941-2.497995l-152.739642 101.819762c-38.19391 25.46394-89.983789 30.687928-134.547685 16.83596 40.119906-8.159981 76.075822-36.303915 97.587772-78.607815 22.019948-43.289899 35.173918-92.551783 38.483909-143.543664a359.187158 359.187158 0 0 1 46.565891 4.811989c49.457884 8.43998 95.745776 27.181936 133.859686 54.203873 12.80197 9.075979 24.789942 19.169955 35.623917 30.005929 6.887984 6.891984 5.367987 14.809965-2.619994 20.135953z" fill="" p-id="32760"></path>
                        </svg>
                        <span>60觉点</span> 
                    </div>
                    <div class="v-shex">
                        <svg t="1563346501491" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5668" width="60" height="60">
                        	<path d="M94.08 261.12zM898.44 702.9l28.89 16.68z m-47.11-339.56l-70.67 40.8zM126.08 253.12zM772.66 221.11H102.08a40.12 40.12 0 0 0-40 40V759a40.12 40.12 0 0 0 40 40h670.58a40.12 40.12 0 0 0 40-40v-68.68L959.33 775V264l-146.67 84.72v-87.6a40.12 40.12 0 0 0-40-40zM126.08 735V285.11h622.58v174.46l96-55.43 50.68-29.26v289.27l-50.68-29.25-96-55.43V735z" p-id="5669" fill="#f6f2f2"></path>
                        	<path d="M245.8 463.44a38 38 0 1 1 38-38 38 38 0 0 1-38 38z" p-id="5670" fill="#f6f2f2"></path><path d="M245.8 419.44a6 6 0 1 1-6 6 6 6 0 0 1 6-6m0-64a70 70 0 1 0 70 70 70 70 0 0 0-70-70z" p-id="5671" fill="#f6f2f2"></path>
                        </svg>
                        <span>1:30:20</span>
                    </div>

                    <div class="v-share">
                            <svg t="1563272189675" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33492" width="50" height="50">
                                <path d="M977.6 99.2c-3.2-2.4-7.2-2.4-10.4-0.8l-937.6 480c-3.2 1.6-5.6 5.6-5.6 9.6s3.2 7.2 6.4 8.8l313.6 100c3.2 0.8 7.2 0 9.6-2.4l434.4-391.2-346.4 410.4c-2.4 2.4-3.2 5.6-1.6 8.8 0.8 3.2 3.2 5.6 6.4 6.4l348 106.4c0.8 0 1.6 0.8 2.4 0.8 1.6 0 3.2-0.8 4.8-1.6 2.4-1.6 4-3.2 4.8-6.4l174.4-718.4c0.8-4 0-8-3.2-10.4zM548 804l-96-29.6c-3.2-0.8-6.4 0-8.8 1.6-2.4 1.6-4 4.8-4 8v181.6c0 4 3.2 8 7.2 9.6h2.4c3.2 0 6.4-1.6 8-4.8l96-152c1.6-2.4 1.6-5.6 0.8-8.8 0-2.4-2.4-4.8-5.6-5.6z" p-id="33493" fill="#ffffff"></path>
                            </svg>
                            
                    </div>
                </div>
				<!-- <button onclick="createVideoPlayer()">创建视频播放控件</button> -->
            </div>
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script>
            var mediaStream;
            var recorderFile;
            var stopRecordCallback;
            var openBtn = document.getElementById("openCamera");
            var startBtn = document.getElementById("start-recording");
            var saveBtn = document.getElementById("save-recording");
            
            openBtn.onclick = function() {
                this.disabled = true;
                startBtn.disabled=false;
                openCamera();
            };
            startBtn.onclick = function() {
                this.disabled = true;
                startRecord();
            };
            saveBtn.onclick = function() {
                saver();
                // alert('Drop WebM file on Chrome or Firefox. Both can play entire file. VLC player or other players may not work.');
            };
            var mediaRecorder;
            var videosContainer = document.getElementById('videos-container');
            function openCamera(){
                var len = videosContainer.childNodes.length;
                for(var i=0;i<len;i++){
                    videosContainer.removeChild(videosContainer.childNodes[i]);
                }
                var video = document.createElement('video');
                var videoWidth = 320;
                var videoHeight = 240;
                video.controls = false;
                video.muted = true;
                video.width = window.clientWidth;
                video.height = window.clientHeight;
                MediaUtils.getUserMedia(true, true, function (err, stream) {
                    if (err) {
                        throw err;
                    } else {
                        // 通过 MediaRecorder 记录获取到的媒体流
                        console.log();
                        mediaRecorder = new MediaRecorder(stream);
                        mediaStream = stream;
                        console.log(stream,mediaStream)
                        var chunks = [], startTime = 0;
                        video.srcObject = stream;
                        video.play();
                        videosContainer.appendChild(video);
                        mediaRecorder.ondataavailable = function(e) {
                            mediaRecorder.blobs.push(e.data);
                            chunks.push(e.data);
                        };
                        mediaRecorder.blobs = [];
                        mediaRecorder.onstop = function (e) {
                            recorderFile = new Blob(chunks, { 'type' : mediaRecorder.mimeType });
                            chunks = [];
                            if (null != stopRecordCallback) {
                                stopRecordCallback();
                            }
                        };
                }
            });
            }
            // 停止录制
            function stopRecord(callback) {
                stopRecordCallback = callback;
                // 终止录制器
                mediaRecorder.stop();
                // 关闭媒体流
                MediaUtils.closeStream(mediaStream);
            }
            var MediaUtils = {
                /**
                * 获取用户媒体设备(处理兼容的问题)
                * @param videoEnable {boolean} - 是否启用摄像头
                * @param audioEnable {boolean} - 是否启用麦克风
                * @param callback {Function} - 处理回调
                */
                getUserMedia: function (videoEnable, audioEnable, callback) {
                    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia
                    || navigator.msGetUserMedia || window.getUserMedia;
                    var constraints = {video: videoEnable, audio: audioEnable};
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                        callback(false, stream);
                    })['catch'](function(err) {
                        callback(err);
                    });
                    } else if (navigator.getUserMedia) {
                        navigator.getUserMedia(constraints, function (stream) {
                            callback(false, stream);
                        }, function (err) {
                            callback(err);
                        });
                    } else {
                        callback(new Error('Not support userMedia'));
                    }
            },
                /**
                * 关闭媒体流
                * @param stream {MediaStream} - 需要关闭的流
                */
                closeStream: function (stream) {
                    if (typeof stream.stop === 'function') {
                        stream.stop();
                    }
                    else {
                        let trackList = [stream.getAudioTracks(), stream.getVideoTracks()];
                        for (let i = 0; i < trackList.length; i++) {
                            let tracks = trackList[i];
                            if (tracks && tracks.length > 0) {
                                for (let j = 0; j < tracks.length; j++) {
                                    let track = tracks[j];
                                    if (typeof track.stop === 'function') {
                                        track.stop();
                                    }
                                }
                            }
                        }
                    }
                }
            }; 
        function startRecord() {
            mediaRecorder.start();
            setTimeout(function(){
                // 结束
                stopRecord(function() {
                    alert("录制成功!");
                    openBtn.disabled=false;
                    saveBtn.disabled=false;
                    send();
                });
            }, 5000);
        }
        function saver(){
            var file = new File([recorderFile], 'msr-' + (new Date).toISOString().replace(/:|\./g, '-') + '.mp4', {
                type: 'video/mp4'
            });
            saveAs(file);
        }
        function send(){
            var file = new File([recorderFile], 'msr-' + (new Date).toISOString().replace(/:|\./g, '-') + '.mp4', {
                type: 'video/mp4'
            });
            var data = new FormData();
            data.append("video", file);
            var req = new XMLHttpRequest();
            req.open("POST", "rtmp://127.0.0.1:1935/live");
            req.setRequestHeader("Content-type","application/x-www-form-urlencoded");
            req.send(data);
            alert('状态：'+req.status,'原因：'+req.statusText)
        }
</script>

</body>

</html>
